# Nexus 应用配置

app {
  # 服务器配置
  http {
    host = "0.0.0.0"
    host = ${?HTTP_HOST}
    port = 8080
    port = ${?HTTP_PORT}
  }

  # 数据库配置
  db {
    dataSourceClassName = "org.postgresql.ds.PGSimpleDataSource"
    dataSource {
      url = "jdbc:postgresql://localhost:5432/postgres"
      url = ${?DATABASE_URL}
      user = "postgres"
      user = ${?DATABASE_USER}
      password = "postgres"
      password = ${?DATABASE_PASSWORD}
    }
    connectionTimeout = 30000
    maximumPoolSize = 10
    idleTimeout = 600000
    maxLifetime = 1800000
  }

  # Neuro gRPC 客户端配置
  cloud {
    healthCheckInterval = 30s

    clusters {
      cluster-us-west {
        grpc {
          connection {
            neuro {
              host = "localhost"
              host = ${?NEURO_HOST}
              port = 50051
            }
            nebula {
              host = "localhost"
              port = 50052
            }
            limits {
              maxInboundMessageSize = 4194304  # 4MB
              maxInboundMetadataSize = 8192     # 8KB
              flowControlWindow = 1048576        # 1MB
            }
            keepAlive {
              time = 30s
              timeout = 10s
              withoutCalls = true
            }
            transport {
              usePlaintext = true  # TLS in production
              userAgent = "Mosia-Nexus/1.0"
              loadBalancingPolicy = "round_robin"
              idleTimeout = 30m
              connectTimeout = 10s
            }
          }
          poolSize = 8
        }
        websocket {
          baseUrl = ""
          controlPath = ""
        }
        location {
          latitude = 37.7749
          longitude = -122.4194
          country = "US"
          city = "San Francisco"
        }

        capacity = 100
        priority = 10
        tags = ["gpu", "high-memory"]
      }
    }
  }

  # JWT 认证配置
  auth {
    token {
      secret = "your-secret-key-change-in-production"
      secret = ${?JWT_SECRET_KEY}
      issuer = "https://nexus.mosia.app"
      audience = "mosia.app"

      # Token 有效期
      expiration {
        accessToken = 1h
        refreshToken = 7d
        controlToken = 24h  # WebSocket 控制 token
      }

      # 算法
      algorithm = "HS256"
    }

    oauth {
      clients {
        github {
          mode = "mock" # 可选: "mock" 或 "production"
          clientId = "123"
          clientId = ${?APP_GITHUB_CLIENT_ID}
          clientSecret = "123"
          clientSecret = ${?APP_GITHUB_CLIENT_SECRET}
          authorizationUrl = "https://github.com/login/oauth/authorize"
          accessTokenUrl = "https://github.com/login/oauth/access_token"
          userInfoUrl = "https://api.github.com/user"
          redirectUri = "http://localhost:8080/oauth/callback/github"
          mockUrl = "http://localhost:8088"
          scope = "user:email"
        }

        google {
          mode = "mock" # 可选: "mock" 或 "production"
          clientId = "123"
          clientId = ${?APP_GOOGLE_CLIENT_ID}
          clientSecret = "123"
          clientSecret = ${?APP_GOOGLE_CLIENT_SECRET}
          authorizationUrl = "https://accounts.google.com/o/oauth2/v2/auth"
          accessTokenUrl = "https://oauth2.googleapis.com/token"
          userInfoUrl = "https://www.googleapis.com/oauth2/v2/userinfo"
          redirectUri = "http://localhost:8080/oauth/callback/google"
          mockUrl = "http://localhost:8089"
          scope = "user:user"
        }
      }
    }

    baseUrl = "localhost:8080"
  }

  # Redis Streams 配置（用于高频非关键事件）
  streams {
    # 是否启用事件发布
    enabled = true
    enabled = ${?STREAMS_ENABLED}

    # Stream 清理配置
    cleanup {
      enabled = true
      interval = 1h
      maxLength = 100000  # 每个 Stream 保留最多 10 万条消息
    }

    # 消费者配置
    consumer {
      batchSize = 10  # 每次读取消息数量
      blockTimeMs = 1000  # 阻塞读取超时（毫秒）
    }
  }

  # PostgreSQL Outbox 配置（用于关键业务事件，需要事务一致性）
  outbox {
    # 是否启用 Outbox Pattern
    enabled = true
    enabled = ${?OUTBOX_ENABLED}

    # 处理器配置
    processor {
      # 轮询间隔
      pollInterval = 1s
      pollInterval = ${?OUTBOX_POLL_INTERVAL}

      # 每次处理的事件数量
      batchSize = 100
      batchSize = ${?OUTBOX_BATCH_SIZE}

      # 最大重试次数
      maxRetries = 3
      maxRetries = ${?OUTBOX_MAX_RETRIES}
    }

    # 清理配置
    cleanup {
      # 是否启用自动清理
      enabled = true

      # 清理间隔
      interval = 1h

      # 保留天数（已发布的事件）
      retentionDays = 7
      retentionDays = ${?OUTBOX_RETENTION_DAYS}
    }
  }

  # 事件发布策略（Hybrid）
  eventPublishing {
    # 默认策略: hybrid, outbox, streams
    # hybrid: 智能路由（关键事件用 Outbox，其他用 Streams）
    # outbox: 所有事件都用 Outbox
    # streams: 所有事件都用 Redis Streams
    defaultStrategy = "hybrid"
    defaultStrategy = ${?EVENT_PUBLISHING_STRATEGY}
  }

  # 资源配额配置
  quota {
    # 默认配额
    default {
      maxConcurrentSessions = 5
      maxGpuHoursPerMonth = 100.0
      maxStorageGb = 50.0
    }

    # 验证间隔
    checkInterval = 1m

    # 配额超限行为
    onExceeded = "reject"  # reject, queue, throttle
  }

  # 监控配置
  monitoring {
    prometheus {
      enabled = true
      port = 9090
      path = "/metrics"
    }

    # 健康检查
    healthCheck {
      enabled = true
      path = "/health"
      interval = 30s
    }

    # 指标收集
    metrics {
      # 会话指标同步间隔
      sessionSyncInterval = 5s
      # 训练进度更新间隔
      trainingUpdateInterval = 1s
      # 系统指标收集
      collectSystemMetrics = true
    }
  }

  # 后台任务配置
  jobs {
    # 会话指标同步
    sessionMetricsSync {
      enabled = true
      interval = 5s
      batchSize = 50
    }

    # 训练进度更新
    trainingProgressSync {
      enabled = true
      interval = 1s
    }

    # 配额使用统计
    quotaUsageCalculation {
      enabled = true
      interval = 1h
      cron = "0 0 * * * ?"  # 每小时整点
    }

    # 清理过期会话
    expiredSessionCleanup {
      enabled = true
      interval = 1h
      retentionDays = 30
    }
  }

  # 功能开关
  features {
    # 实时订阅
    graphqlSubscriptions = true
    # 高频 WebSocket 控制
    websocketControl = true
    # 事件发布
    eventPublishing = true
    # 指标导出
    metricsExport = true
  }

  # 限流配置
  limit {
    enabled = true
    enabled = ${?RATE_LIMIT_ENABLED}

    # 按 IP 限流
    perIp {
      requestsPerSecond = 100
      burstSize = 200
    }

    # 按用户限流
    perUser {
      requestsPerSecond = 50
      burstSize = 100
    }

    # API 端点特定限流
    endpoints {
      createSession {
        requestsPerMinute = 10
      }
      startTraining {
        requestsPerMinute = 5
      }
    }
  }

  # CORS 配置
  cors {
    enabled = true
    allowedOrigins = ["http://localhost:3000", "https://mosia.app"]
    allowedOrigins = ${?CORS_ALLOWED_ORIGINS}
    allowedMethods = ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
    allowedHeaders = ["Content-Type", "Authorization", "X-Requested-With"]
    exposedHeaders = ["X-Total-Count", "X-Page-Number"]
    maxAge = 3600
    allowCredentials = true
  }

  cache {
    cacheEnabled = true
    geoip {
      cacheTtl = 1h
      cacheMaxSize = 10000
    }
    redis {
      # Redis URI 格式: redis://[user:password@]host:port[/database]
      # Upstash 格式: rediss://default:password@host:port
      uri = "redis://localhost:6379"
      uri = ${?REDIS_URI}
    }
  }

  # RabbitMQ 配置（用于外部通知：邮件、短信）
  rabbitmq {
    host = "localhost"
    host = ${?RABBITMQ_HOST}
    port = 5672
    port = ${?RABBITMQ_PORT}
    username = "guest"
    username = ${?RABBITMQ_USERNAME}
    password = "guest"
    password = ${?RABBITMQ_PASSWORD}
    virtualHost = "/"
    # virtualHost = ${?RABBITMQ_VIRTUAL_HOST}

    # Exchange 配置（用于发布通知事件）
    exchange = "nexus.notifications"
    exchange = ${?RABBITMQ_EXCHANGE}

    # 队列名称前缀
    queue = "nexus.notifications"
    queue = ${?RABBITMQ_QUEUE}
  }

  # 通知配置（邮件 + 短信）
  notification {
    # SMTP 邮件配置
    email {
      host = "smtppro.zoho.com"
      host = ${?SMTP_HOST}
      port = 465
      port = ${?SMTP_PORT}
      username = "your@mosia.app"
      username = ${?SMTP_USERNAME}
      password = "your-app-password"
      password = ${?SMTP_PASSWORD}
      from = "noreply@mosia.app"
      from = ${?SMTP_FROM}
      fromName = "Mosia Technologies LLC"
      fromName = ${?SMTP_FROM_NAME}
      useTls = true
      useTls = ${?SMTP_USE_TLS}
    }

    # 阿里云短信配置
    sms {
      accessKeyId = "your-access-key-id"
      accessKeyId = ${?ALIYUN_SMS_ACCESS_KEY_ID}
      accessKeySecret = "your-access-key-secret"
      accessKeySecret = ${?ALIYUN_SMS_ACCESS_KEY_SECRET}
      signName = "Nexus"
      signName = ${?ALIYUN_SMS_SIGN_NAME}
      templateCode = "SMS_123456789"
      templateCode = ${?ALIYUN_SMS_TEMPLATE_CODE}
      endpoint = "dysmsapi.aliyuncs.com"
      endpoint = ${?ALIYUN_SMS_ENDPOINT}
    }
  }
}