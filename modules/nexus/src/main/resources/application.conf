# Nexus 应用配置

app {
  # 服务器配置
  http {
    host = "0.0.0.0"
    host = ${?HTTP_HOST}
    port = 8080
    port = ${?HTTP_PORT}
  }

  # 数据库配置
  db {
    default {
      dataSourceClassName = "org.postgresql.ds.PGSimpleDataSource"
      dataSource {
        serverName = "localhost"
        portNumber = 5432
        databaseName = "nexus"
        user = "mosia"
        user = ${?DB_USER}
        password = "ttr851217"
        password = ${?DB_PASSWORD}
      }
      connectionTimeout = 30000
      maximumPoolSize = 10
      idleTimeout = 600000
      maxLifetime = 1800000
    }

    timescale {
      dataSourceClassName = "org.postgresql.ds.PGSimpleDataSource"
      dataSource {
        serverName = "localhost"
        portNumber = 5433
        databaseName = "nexus-ts"
        user = "mosia"
        user = ${?DB_USER}
        password = "ttr851217"
        password = ${?DB_PASSWORD}
      }
      connectionTimeout = 30000
      maximumPoolSize = 10
      idleTimeout = 600000
      maxLifetime = 1800000
    }
  }

  # Neuro gRPC 客户端配置
  neuro {
    healthCheckInterval = 30s

    clusters {
      cluster-us-west {
        grpc {
          connection {
            endpoint {
              host = "localhost"
              port = 50051
            }
            limits {
              maxInboundMessageSize = 4194304  # 4MB
              maxInboundMetadataSize = 8192     # 8KB
              flowControlWindow = 1048576        # 1MB
            }
            keepAlive {
              time = 30s
              timeout = 10s
              withoutCalls = true
            }
            transport {
              usePlaintext = true  # TLS in production
              userAgent = "Mosia-Nexus/1.0"
              loadBalancingPolicy = "round_robin"
              idleTimeout = 30m
              connectTimeout = 10s
            }
          }
          poolSize = 8
        }
        websocket {
          baseUrl = ""
          controlPath = ""
        }
        location {
          latitude = 37.7749
          longitude = -122.4194
          country = "US"
          city = "San Francisco"
        }

        capacity = 100
        priority = 10
        tags = ["gpu", "high-memory"]
      }
    }
  }

  # JWT 认证配置
  auth {
    token {
      secret = "your-secret-key-change-in-production"
      secret = ${?JWT_SECRET}
      issuer = "https://nexus.mosia.app"
      audience = "mosia.app"

      # Token 有效期
      expiration {
        accessToken = 1h
        refreshToken = 7d
        controlToken = 24h  # WebSocket 控制 token
      }

      # 算法
      algorithm = "HS256"
    }

    oauth {
      clients {
        github {
          clientId = "123"
          clientId = ${?APP_GITHUB_CLIENT_ID}
          clientSecret = "123"
          clientSecret = ${?APP_GITHUB_CLIENT_SECRET}
          authorizationUrl = "https://github.com/login/oauth/authorize"
          tokenUrl = "https://github.com/login/oauth/access_token"
          userInfoUrl = "https://api.github.com/user"
          redirectUri = "http://localhost:8080/oauth/callback/github"
          scope = "user:user"
        }

        google {
          clientId = "123"
          clientId = ${?APP_GOOGLE_CLIENT_ID}
          clientSecret = "123"
          clientSecret = ${?APP_GOOGLE_CLIENT_SECRET}
          authorizationUrl = "https://accounts.google.com/o/oauth2/v2/auth"
          tokenUrl = "https://oauth2.googleapis.com/token"
          userInfoUrl = "https://www.googleapis.com/oauth2/v2/userinfo"
          redirectUri = "http://localhost:8080/oauth/callback/google"
          scope = "user:user"
        }
      }
    }

    baseUrl = "mosia.app"
  }

  # Kafka 事件流配置
  kafka {
    bootstrapServers = ["localhost:9092"]
    bootstrapServers = ${?KAFKA_BOOTSTRAP_SERVERS}

    producer {
      clientId = "nexus-producer"
      clientId = ${?KAFKA_PRODUCER_CLIENT_ID}
      acks = "all"
      retries = 3
      batchSize = 16384
      lingerMs = 10
      compressionType = "snappy"
    }

    consumer {
      groupId = "nexus-consumer-group"
      groupId = ${?KAFKA_CONSUMER_GROUP}
      autoOffsetReset = "earliest"
      enableAutoCommit = false
      maxPollRecords = 500
    }

    topics {
      domainEvents = "nexus.domain-events"
      sessionEvents = "nexus.session-events"
      trainingEvents = "nexus.training-events"
      metrics = "nexus.metrics"
    }
  }

  # 资源配额配置
  quota {
    # 默认配额
    default {
      maxConcurrentSessions = 5
      maxGpuHoursPerMonth = 100.0
      maxStorageGb = 50.0
    }

    # 验证间隔
    checkInterval = 1m

    # 配额超限行为
    onExceeded = "reject"  # reject, queue, throttle
  }

  # 监控配置
  monitoring {
    prometheus {
      enabled = true
      port = 9090
      path = "/metrics"
    }

    # 健康检查
    healthCheck {
      enabled = true
      path = "/health"
      interval = 30s
    }

    # 指标收集
    metrics {
      # 会话指标同步间隔
      sessionSyncInterval = 5s
      # 训练进度更新间隔
      trainingUpdateInterval = 1s
      # 系统指标收集
      collectSystemMetrics = true
    }
  }

  # 后台任务配置
  jobs {
    # 会话指标同步
    sessionMetricsSync {
      enabled = true
      interval = 5s
      batchSize = 50
    }

    # 训练进度更新
    trainingProgressSync {
      enabled = true
      interval = 1s
    }

    # 配额使用统计
    quotaUsageCalculation {
      enabled = true
      interval = 1h
      cron = "0 0 * * * ?"  # 每小时整点
    }

    # 清理过期会话
    expiredSessionCleanup {
      enabled = true
      interval = 1h
      retentionDays = 30
    }
  }

  # 功能开关
  features {
    # 实时订阅
    graphqlSubscriptions = true
    # 高频 WebSocket 控制
    websocketControl = true
    # 事件发布
    eventPublishing = true
    # 指标导出
    metricsExport = true
  }

  # 限流配置
  limit {
    enabled = true
    enabled = ${?RATE_LIMIT_ENABLED}

    # 按 IP 限流
    perIp {
      requestsPerSecond = 100
      burstSize = 200
    }

    # 按用户限流
    perUser {
      requestsPerSecond = 50
      burstSize = 100
    }

    # API 端点特定限流
    endpoints {
      createSession {
        requestsPerMinute = 10
      }
      startTraining {
        requestsPerMinute = 5
      }
    }
  }

  # CORS 配置
  cors {
    enabled = true
    allowedOrigins = ["http://localhost:3000", "https://mosia.app", "https://www.mosia.app"]
    allowedOrigins = ${?CORS_ALLOWED_ORIGINS}
    allowedMethods = ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
    allowedHeaders = ["Content-Type", "Authorization", "X-Requested-With"]
    exposedHeaders = ["X-Total-Count", "X-Page-Number"]
    maxAge = 3600
    allowCredentials = true
  }

  cache {
    cacheEnabled = true
    geoip {
      cacheTtl = 1h
      cacheMaxSize = 10000
    }
  }
}

# 迁移配置
migration {
  postgres {
    url = "jdbc:postgresql://localhost:5432/nexus"
    url = ${?POSTGRES_URL}
    user = "mosia"
    user = ${?POSTGRES_USER}
    password = "ttr851217"
    password = ${?POSTGRES_PASSWORD}
    maxPoolSize = 10
  }

  timescale {
    url = "jdbc:postgresql://localhost:5433/nexus-ts"
    url = ${?TIMESCALE_URL}
    user = "mosia"
    user = ${?TIMESCALE_USER}
    password = "ttr851217"
    password = ${?TIMESCALE_PASSWORD}
    maxPoolSize = 10
  }

  locations {
    postgres = "classpath:db/migration/postgres"
    timescale = "classpath:db/migration/timescale"
  }

  codegen {
    enabled = true
    output-dir = "src/main/scala"  # 或使用绝对路径
    postgres-package = "infra.persistence.postgres.generated"
    timescale-package = "infra.persistence.timescale.generated"
  }

  validateOnly = false
  validateOnly = ${?MIGRATION_VALIDATE_ONLY}

  cleanDisabled = true
  baselineOnMigrate = true
}