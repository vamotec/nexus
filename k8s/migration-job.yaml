# k8s/migration-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: nexus-db-migration
  namespace: production
  labels:
    app: nexus
    component: migration
spec:
  # 只运行一次
  completions: 1
  parallelism: 1
  backoffLimit: 3
  ttlSecondsAfterFinished: 86400  # 24小时后自动清理

  template:
    metadata:
      labels:
        app: nexus
        component: migration
    spec:
      restartPolicy: Never

      containers:
        - name: migration
          image: your-registry/nexus:latest
          imagePullPolicy: IfNotPresent

          # 运行迁移工具
          command: ["java"]
          args:
            - "-jar"
            - "app.jar"
            - "migration"  # 触发 MigrationRunner

          env:
            - name: POSTGRES_URL
              valueFrom:
                configMapKeyRef:
                  name: nexus-config
                  key: POSTGRES_URL
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: nexus-db-secret
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nexus-db-secret
                  key: POSTGRES_PASSWORD
            - name: TIMESCALE_URL
              valueFrom:
                configMapKeyRef:
                  name: nexus-config
                  key: TIMESCALE_URL
            - name: TIMESCALE_USER
              valueFrom:
                secretKeyRef:
                  name: nexus-db-secret
                  key: TIMESCALE_USER
            - name: TIMESCALE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nexus-db-secret
                  key: TIMESCALE_PASSWORD

          resources:
            requests:
              memory: "512Mi"
              cpu: "500m"
            limits:
              memory: "1Gi"
              cpu: "1000m"

      # 确保数据库服务可用
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.36
          command: ['sh', '-c']
          args:
            - |
              until nc -z postgres-service 5432; do
                echo "Waiting for PostgreSQL..."
                sleep 2
              done
              echo "PostgreSQL is ready!"

        - name: wait-for-timescale
          image: busybox:1.36
          command: ['sh', '-c']
          args:
            - |
              until nc -z timescaledb-service 5432; do
                echo "Waiting for TimescaleDB..."
                sleep 2
              done
              echo "TimescaleDB is ready!"