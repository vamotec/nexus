# Nexus 应用配置

app {
  # 服务器配置
  http {
    host = "0.0.0.0"
    host = ${?HTTP_HOST}
    port = 8080
    port = ${?HTTP_PORT}
  }

  graphql {
    host = "0.0.0.0"
    host = ${?GRAPHQL_HOST}
    port = 8081
    port = ${?GRAPHQL_PORT}
    playground-enabled = true
    playground-enabled = ${?GRAPHQL_PLAYGROUND_ENABLED}
  }

  metrics {
    port = 9090
    port = ${?METRICS_PORT}
  }

  # 数据库配置
  db {
    default {
      dataSourceClassName = "org.postgresql.ds.PGSimpleDataSource"
      dataSource {
        serverName = "localhost"
        portNumber = 5432
        databaseName = "mosia_ps"
        user = "mosia"
        user = ${?DB_USER}
        password = ${?DB_PASSWORD}
      }
      connectionTimeout = 30000
      maximumPoolSize = 10
    }
    timescale {
      dataSourceClassName = "org.postgresql.ds.PGSimpleDataSource"
      dataSource {
        serverName = "localhost"
        portNumber = 5433
        databaseName = "mosia_ts"
        user = "mosia"
        user = ${?DB_USER}
        password = ${?DB_PASSWORD}
      }
      connectionTimeout = 30000
      maximumPoolSize = 10
    }
  }

  # Neuro gRPC 客户端配置
  neuro {
    grpc {
      host = "localhost"
      host = ${?NEURO_GRPC_HOST}
      port = 50051
      port = ${?NEURO_GRPC_PORT}

      # 连接配置
      connection {
        max-inbound-message-size = 10MB
        keep-alive-time = 30s
        keep-alive-timeout = 10s
        idle-timeout = 5m
      }

      # 重试配置
      retry {
        max-attempts = 3
        initial-backoff = 1s
        max-backoff = 10s
        backoff-multiplier = 2
      }

      # 超时配置
      timeout {
        create-session = 30s
        start-simulation = 10s
        get-status = 5s
        start-training = 30s
      }
    }

    # WebSocket 控制端点 (高频通道)
    websocket {
      base-url = "ws://localhost:8765"
      base-url = ${?NEURO_WS_BASE_URL}
      control-path = "/control"

      # 连接配置
      connection {
        timeout = 10s
        max-frame-size = 65536
        ping-interval = 30s
      }
    }
  }

  # Kafka 事件流配置
  kafka {
    bootstrap-servers = "localhost:9092"
    bootstrap-servers = ${?KAFKA_BOOTSTRAP_SERVERS}

    producer {
      client-id = "nexus-producer"
      acks = "all"
      retries = 3
      batch-size = 16384
      linger-ms = 10
      compression-type = "snappy"
    }

    consumer {
      group-id = "nexus-consumer-group"
      group-id = ${?KAFKA_CONSUMER_GROUP}
      auto-offset-reset = "earliest"
      enable-auto-commit = false
      max-poll-records = 500
    }

    # 主题配置
    topics {
      domain-events = "nexus.domain-events"
      session-events = "nexus.session-events"
      training-events = "nexus.training-events"
      metrics = "nexus.metrics"
    }
  }

  # JWT 认证配置
  auth {
    jwt {
      secret = "your-secret-key-change-in-production"
      secret = ${?JWT_SECRET}
      issuer = "robosim-nexus"
      audience = "robosim-users"

      # Token 有效期
      expiration {
        access-token = 1h
        refresh-token = 7d
        control-token = 24h  # WebSocket 控制 token
      }

      # 算法
      algorithm = "HS256"
    }

    # 密码哈希
    password {
      algorithm = "bcrypt"
      rounds = 12
    }
  }

  # 资源配额配置
  quota {
    # 默认配额
    default {
      max-concurrent-sessions = 5
      max-gpu-hours-per-month = 100.0
      max-storage-gb = 50.0
    }

    # 验证间隔
    check-interval = 1m

    # 配额超限行为
    on-exceeded = "reject"  # reject, queue, throttle
  }

  # 监控配置
  monitoring {
    prometheus {
      enabled = true
      port = 9090
      path = "/metrics"
    }

    # 健康检查
    health-check {
      enabled = true
      path = "/health"
      interval = 30s
    }

    # 指标收集
    metrics {
      # 会话指标同步间隔
      session-sync-interval = 5s

      # 训练进度更新间隔
      training-update-interval = 1s

      # 系统指标收集
      collect-system-metrics = true
    }
  }

  # 日志配置
  logging {
    level = "INFO"
    level = ${?LOG_LEVEL}

    # 按包配置日志级别
    loggers {
      "com.robosim.nexus.domain" = "DEBUG"
      "com.robosim.nexus.infrastructure.grpc" = "DEBUG"
      "io.grpc" = "WARN"
      "org.flywaydb" = "INFO"
    }

    # 结构化日志
    structured = true
    structured = ${?LOG_STRUCTURED}

    # 日志输出
    appenders {
      console {
        enabled = true
        pattern = "%d{yyyy-MM-dd HH:mm:ss} [%level] %logger{36} - %msg%n"
      }

      file {
        enabled = false
        path = "/var/log/nexus/nexus.log"
        path = ${?LOG_FILE_PATH}
        max-size = "100MB"
        max-history = 30
      }
    }
  }

  # 后台任务配置
  background-jobs {
    # 会话指标同步
    session-metrics-sync {
      enabled = true
      interval = 5s
      batch-size = 50
    }

    # 训练进度更新
    training-progress-sync {
      enabled = true
      interval = 1s
    }

    # 配额使用统计
    quota-usage-calculation {
      enabled = true
      interval = 1h
      cron = "0 0 * * * ?"  # 每小时整点
    }

    # 清理过期会话
    expired-session-cleanup {
      enabled = true
      interval = 1h
      retention-days = 30
    }
  }

  # 功能开关
  features {
    # GraphQL Playground
    graphql-playground = true
    graphql-playground = ${?FEATURE_GRAPHQL_PLAYGROUND}

    # 实时订阅
    graphql-subscriptions = true

    # 高频 WebSocket 控制
    websocket-control = true

    # 事件发布
    event-publishing = true

    # 指标导出
    metrics-export = true
  }

  # 限流配置
  rate-limit {
    enabled = true
    enabled = ${?RATE_LIMIT_ENABLED}

    # 按 IP 限流
    per-ip {
      requests-per-second = 100
      burst-size = 200
    }

    # 按用户限流
    per-user {
      requests-per-second = 50
      burst-size = 100
    }

    # API 端点特定限流
    endpoints {
      create-session {
        requests-per-minute = 10
      }
      start-training {
        requests-per-minute = 5
      }
    }
  }

  # CORS 配置
  cors {
    enabled = true
    allowed-origins = ["http://localhost:3000", "https://mosia.app", "https://www.mosia.app"]
    allowed-origins = ${?CORS_ALLOWED_ORIGINS}
    allowed-methods = ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
    allowed-headers = ["Content-Type", "Authorization", "X-Requested-With"]
    exposed-headers = ["X-Total-Count", "X-Page-Number"]
    max-age = 3600
    allow-credentials = true
  }
}

# Quill 数据库上下文配置
ctx {
  dataSourceClassName = "org.postgresql.ds.PGSimpleDataSource"
  dataSource {
    user = ${app.database.postgres.user}
    password = ${app.database.postgres.password}
    databaseName = "mosia_dev"
    portNumber = 5432
    serverName = "localhost"
  }
}